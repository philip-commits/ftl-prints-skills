<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTL Prints — Action Dashboard</title>
<style>
  :root {
    --bg: #0f172a; --surface: #1e293b; --surface2: #334155;
    --text: #f1f5f9; --text2: #94a3b8; --accent: #38bdf8;
    --red: #ef4444; --red-bg: #450a0a; --yellow: #eab308; --yellow-bg: #422006;
    --green: #22c55e; --green-bg: #052e16; --border: #334155;
    --purple: #818cf8; --purple-bg: #1e1b4b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.6; padding: 24px; max-width: 1000px; margin: 0 auto; }
  h1 { font-size: 1.5rem; margin-bottom: 4px; }
  .date { color: var(--text2); font-size: 0.9rem; margin-bottom: 24px; }
  .stats { display: flex; gap: 12px; margin-bottom: 32px; flex-wrap: wrap; }
  .stat-pill { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 8px 16px; font-size: 0.85rem; }
  .stat-pill .num { font-weight: 700; }
  .stat-pill.high .num { color: var(--red); }
  .stat-pill.med .num { color: var(--yellow); }
  .stat-pill.low .num { color: var(--text2); }

  .priority-group { margin-bottom: 28px; }
  .priority-label { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em;
    color: var(--text2); margin-bottom: 12px; cursor: pointer; user-select: none; }
  .priority-label.high { color: var(--red); }
  .priority-label.med { color: var(--yellow); }
  .priority-label.info { color: var(--purple); }

  .action-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 16px 20px; margin-bottom: 12px; }
  .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
  .card-badges { display: flex; gap: 6px; flex-wrap: wrap; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
  .badge.reply { background: var(--red-bg); color: var(--red); }
  .badge.outreach { background: var(--red-bg); color: var(--red); }
  .badge.followup { background: var(--yellow-bg); color: var(--yellow); }
  .badge.gather { background: var(--yellow-bg); color: var(--yellow); }
  .badge.quote-fu { background: var(--yellow-bg); color: var(--yellow); }
  .badge.final { background: var(--surface2); color: var(--text2); }
  .badge.move { background: var(--purple-bg); color: var(--purple); }
  .badge.email { background: #1e3a5f; color: #60a5fa; }
  .badge.sms { background: #1a3329; color: #34d399; }
  .badge.call { background: #1a3329; color: #34d399; }
  .badge.intl { background: var(--purple-bg); color: var(--purple); }

  .contact-name { font-weight: 600; font-size: 1rem; }
  .contact-detail { color: var(--text2); font-size: 0.85rem; }
  .context { color: var(--text2); font-size: 0.85rem; margin-bottom: 8px; }
  .recommendation { color: var(--text2); font-size: 0.85rem; margin-bottom: 8px; }

  .preview-toggle { cursor: pointer; color: var(--accent); font-size: 0.8rem; border: none; background: none; padding: 4px 0; }
  .preview-toggle:hover { text-decoration: underline; }
  .msg-preview { background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 12px 16px; margin-top: 8px; display: none; font-size: 0.85rem; }
  .msg-preview.open { display: block; }
  .preview-subject { color: var(--accent); font-size: 0.8rem; margin-bottom: 6px; }
  .preview-body { color: var(--text); }

  .send-btn { padding: 6px 16px; border-radius: 6px; border: none; font-weight: 600; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
  .send-btn.ready { background: var(--accent); color: #0f172a; }
  .send-btn.ready:hover { opacity: 0.85; }
  .send-btn.sent { background: var(--green-bg); color: var(--green); cursor: default; }
  .send-btn.failed { background: var(--red-bg); color: var(--red); cursor: pointer; }
  .send-btn.sending { opacity: 0.5; cursor: wait; }
  .send-btn.move-btn.ready { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple); }

  .section { background: var(--surface); border-radius: 10px; border: 1px solid var(--border); margin-bottom: 20px; overflow: hidden; }
  .section-header { padding: 16px 20px; font-weight: 600; font-size: 0.95rem; cursor: pointer; display: flex;
    justify-content: space-between; align-items: center; user-select: none; color: var(--text2); }
  .section-header:hover { background: var(--surface2); }
  .section-body { padding: 0 20px 16px; display: none; }
  .section-body.open { display: block; }
  .no-action-item { padding: 6px 0; font-size: 0.85rem; color: var(--text2); border-bottom: 1px solid var(--border); }
  .no-action-item:last-child { border-bottom: none; }

  .inactive-bar { display: flex; gap: 24px; padding: 12px 0; }
  .inactive-stat { text-align: center; }
  .inactive-stat .num { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
  .inactive-stat .lbl { font-size: 0.75rem; color: var(--text2); }

  .card-actions { display: flex; gap: 8px; align-items: center; }
  .dismiss-btn { background: none; border: none; color: var(--text2); font-size: 1.2rem; cursor: pointer;
    padding: 2px 6px; line-height: 1; opacity: 0.4; transition: opacity 0.2s, color 0.2s; }
  .dismiss-btn:hover { color: var(--red); opacity: 1; }
  .note-toggle { cursor: pointer; color: var(--text2); font-size: 0.8rem; border: none; background: none; padding: 4px 0; }
  .note-toggle:hover { color: var(--accent); text-decoration: underline; }
  .note-area { background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 12px 16px; margin-top: 8px; }
  .action-card { transition: opacity 0.3s; }

  .icon-btn { background: none; border: 1px solid var(--border); border-radius: 6px;
    color: var(--text2); cursor: pointer; padding: 5px 7px; line-height: 1;
    transition: all 0.15s; display: inline-flex; align-items: center; }
  .icon-btn:hover { color: var(--accent); border-color: var(--accent); }
  .icon-btn.active { color: var(--accent); border-color: var(--accent); background: rgba(56,189,248,0.1); }
  .icon-btn.sent { color: var(--green); border-color: var(--green); background: rgba(34,197,94,0.1); pointer-events: none; }
  .icon-btn[disabled] { opacity: 0.25; cursor: default; pointer-events: none; }
  .compose-area { background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 12px 16px; margin-top: 10px; display: none; }
  .compose-area.open { display: block; }
  .compose-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .compose-label { font-size: 0.8rem; color: var(--text2); font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em; }

  .card-inline-actions { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
  .card-inline-actions .send-btn { padding: 4px 12px; font-size: 0.75rem; }
  .card-inline-actions .msg-preview,
  .card-inline-actions .note-area,
  .card-inline-actions .prior-notes-list { flex-basis: 100%; }

  .prior-notes-toggle { cursor: pointer; color: var(--text2); font-size: 0.8rem; border: none; background: none; padding: 4px 0; }
  .prior-notes-toggle:hover { color: var(--accent); text-decoration: underline; }
  .prior-notes-list { margin-top: 6px; display: none; }
  .prior-notes-list.open { display: block; }
  .prior-note { background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; margin-bottom: 6px; font-size: 0.8rem; }
  .prior-note .note-date { color: var(--text2); font-size: 0.7rem; margin-bottom: 2px; }
  .prior-note .note-body { color: var(--text); }

  .convo-history-toggle { cursor: pointer; color: var(--text2); font-size: 0.8rem; border: none; background: none; padding: 4px 0; }
  .convo-history-toggle:hover { color: var(--accent); text-decoration: underline; }
  .convo-history-list { margin-top: 6px; display: none; }
  .convo-history-list.open { display: block; }
  .convo-msg { background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 12px; margin-bottom: 6px; font-size: 0.8rem; }
  .convo-msg .msg-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 2px; }
  .convo-msg .msg-arrow { font-size: 0.85rem; }
  .convo-msg .msg-arrow.inbound { color: var(--green); }
  .convo-msg .msg-arrow.outbound { color: var(--accent); }
  .convo-msg .msg-channel { font-size: 0.65rem; font-weight: 600; text-transform: uppercase;
    padding: 1px 5px; border-radius: 3px; background: var(--surface2); color: var(--text2); }
  .convo-msg .msg-date { color: var(--text2); font-size: 0.7rem; }
  .convo-msg .msg-body { color: var(--text); margin-top: 2px; }

  .loading { text-align: center; padding: 60px 0; color: var(--text2); font-size: 1.1rem; }
</style>
</head>
<body>

<h1>FTL Prints — Action Dashboard</h1>
<div class="date" id="date-line"></div>

<div id="loading" class="loading">Loading action data...</div>
<div id="dashboard" style="display:none;">
  <div class="stats" id="stats-bar"></div>
  <div id="action-groups"></div>
  <div id="no-action-section"></div>
  <div id="inactive-section"></div>
</div>

<script>
function esc(s) {
  if (s == null) return '';
  const d = document.createElement('div');
  d.textContent = String(s);
  return d.innerHTML;
}
function fmtPhone(p) {
  if (!p) return '';
  const digits = p.replace(/\D/g, '');
  if (digits.length === 11 && digits[0] === '1') {
    return `(${digits.slice(1,4)}) ${digits.slice(4,7)}-${digits.slice(7)}`;
  }
  if (digits.length === 10) {
    return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
  }
  return p;
}

function toggleSection(header) {
  header.nextElementSibling.classList.toggle('open');
}
function togglePreview(btn) {
  const p = btn.nextElementSibling;
  p.classList.toggle('open');
  const isOpen = p.classList.contains('open');
  btn.textContent = isOpen ? '\u25be Hide message' : '\u25b8 Edit message';
  const card = btn.closest('.action-card');
  const sendBtn = card.querySelector('.card-top .card-send-btn');
  if (sendBtn) sendBtn.style.display = isOpen ? '' : 'none';
}
function showCallResult(btn) {
  const card = btn.closest('.action-card');
  card.querySelector('.call-initial').style.display = 'none';
  card.querySelector('.call-result').style.display = 'block';
}
function showAnswered(btn, id) {
  const card = btn.closest('.action-card');
  card.querySelector('.call-result').style.display = 'none';
  card.querySelector('.call-answered').style.display = 'block';
}
function showNoAnswer(btn, id) {
  const card = btn.closest('.action-card');
  card.querySelector('.call-result').style.display = 'none';
  card.querySelector('.call-noanswer').style.display = 'block';
  // Auto-log a "no answer" note for activity tracking
  const today = new Date().toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
  fetch('/api/note/' + id, {method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({body: `Called — no answer (${today})`})}).catch(() => {});
}
function textToHtml(text) {
  return '<p>' + text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
}

async function dismissAction(id, btn) {
  const card = btn.closest('.action-card');
  card.style.opacity = '0';
  setTimeout(() => {
    card.style.display = 'none';
    const group = card.closest('.priority-group');
    if (group) {
      const visible = group.querySelectorAll('.action-card');
      const anyVisible = [...visible].some(c => c.style.display !== 'none');
      if (!anyVisible) group.style.display = 'none';
    }
    updateStats();
  }, 300);
  try { await fetch('/api/dismiss/' + id, {method: 'POST'}); } catch(e) {}
}

function toggleNote(btn) {
  const area = btn.nextElementSibling;
  const isHidden = area.style.display === 'none';
  area.style.display = isHidden ? 'block' : 'none';
  btn.textContent = isHidden ? '\u2212 Hide note' : '+ Add note';
}

function togglePriorNotes(btn) {
  const list = btn.nextElementSibling;
  list.classList.toggle('open');
  const count = list.querySelectorAll('.prior-note').length;
  btn.textContent = list.classList.contains('open')
    ? `\u25be Notes (${count})`
    : `\u25b8 Notes (${count})`;
}

function buildNotesHtml(notes) {
  if (!notes || notes.length === 0) return '';
  let items = '';
  for (const n of notes) {
    const d = n.dateAdded ? new Date(n.dateAdded).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'}) : '';
    items += `<div class="prior-note"><div class="note-date">${esc(d)}</div><div class="note-body">${esc(n.body)}</div></div>`;
  }
  return `<button class="prior-notes-toggle" onclick="togglePriorNotes(this)">\u25b8 Notes (${notes.length})</button><div class="prior-notes-list">${items}</div>`;
}

function toggleConvoHistory(btn) {
  const list = btn.nextElementSibling;
  list.classList.toggle('open');
  const count = list.querySelectorAll('.convo-msg').length;
  btn.textContent = list.classList.contains('open')
    ? `\u25be Messages (${count})`
    : `\u25b8 Messages (${count})`;
}

function buildConvoHistoryHtml(messages) {
  if (!messages || messages.length === 0) return '';
  let items = '';
  for (const m of messages) {
    const dir = m.direction || 'unknown';
    const arrow = dir === 'inbound' ? '\u2190' : '\u2192';
    const arrowCls = dir === 'inbound' ? 'inbound' : 'outbound';
    const channel = (m.channel || '').toUpperCase();
    const d = m.date ? new Date(m.date).toLocaleDateString('en-US', {month:'short', day:'numeric', hour:'numeric', minute:'2-digit'}) : '';
    const body = m.body || '';
    if (!body) continue;
    items += `<div class="convo-msg"><div class="msg-meta"><span class="msg-arrow ${arrowCls}">${arrow}</span><span class="msg-channel">${esc(channel)}</span><span class="msg-date">${esc(d)}</span></div><div class="msg-body">${esc(body)}</div></div>`;
  }
  if (!items) return '';
  return `<button class="convo-history-toggle" onclick="toggleConvoHistory(this)">\u25b8 Messages (${messages.length})</button><div class="convo-history-list">${items}</div>`;
}

async function saveCardNote(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const area = btn.closest('.compose-note') || btn.closest('.note-area');
  const body = area.querySelector('.card-note').value;
  if (!body.trim()) return;
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Saving...';
  try {
    const r = await fetch('/api/note/' + id, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({body})});
    const d = await r.json();
    if (d.success) {
      btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Saved \u2713';
      const card = btn.closest('.action-card');
      if (card) { const icon = card.querySelector('.note-icon'); if (icon) icon.classList.add('sent'); }
    }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

function updateStats() {
  const allCards = document.querySelectorAll('.action-card');
  const visible = [...allCards].filter(c => c.style.display !== 'none');
  const highCount = visible.filter(c => c.dataset.priority === 'high').length;
  const medCount = visible.filter(c => c.dataset.priority === 'medium').length;
  const lowCount = visible.filter(c => c.dataset.priority !== 'high' && c.dataset.priority !== 'medium').length;
  document.getElementById('stats-bar').innerHTML =
    `<div class="stat-pill"><span class="num">${visible.length}</span> Actions</div>` +
    `<div class="stat-pill high"><span class="num">${highCount}</span> High</div>` +
    `<div class="stat-pill med"><span class="num">${medCount}</span> Medium</div>` +
    `<div class="stat-pill low"><span class="num">${lowCount}</span> Low</div>`;
}

async function sendEmail(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const compose = btn.closest('.compose-email');
  const subject = compose.querySelector('.edit-subject').value;
  const message = compose.querySelector('.edit-body').value;
  const html = textToHtml(message);
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Sending...';
  try {
    const r = await fetch('/api/send/' + id, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'Email', subject, message, html})});
    const d = await r.json();
    if (d.success) {
      btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Sent \u2713';
      const card = btn.closest('.action-card');
      if (card) { const icon = card.querySelector('.email-icon'); if (icon) icon.classList.add('sent'); }
    }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

async function sendSms(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const compose = btn.closest('.compose-sms') || btn.closest('.call-noanswer');
  const message = compose.querySelector('.edit-sms').value;
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Sending...';
  try {
    const r = await fetch('/api/send/' + id + '_sms', {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'SMS', message})});
    const d = await r.json();
    if (d.success) {
      btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Sent \u2713';
      const card = btn.closest('.action-card');
      if (card) { const icon = card.querySelector('.sms-icon'); if (icon) icon.classList.add('sent'); }
    }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

async function sendEmailFromCall(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const card = btn.closest('.call-noanswer');
  const subject = card.querySelector('.edit-subject').value;
  const message = card.querySelector('.edit-body').value;
  const html = textToHtml(message);
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Sending...';
  try {
    const r = await fetch('/api/send/' + id + '_email', {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({type:'Email', subject, message, html})});
    const d = await r.json();
    if (d.success) { btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Sent \u2713'; }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

async function saveNote(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const card = btn.closest('.call-answered');
  const body = card.querySelector('.edit-note').value;
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Saving...';
  try {
    const r = await fetch('/api/note/' + id, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({body})});
    const d = await r.json();
    if (d.success) { btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Saved \u2713'; }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

async function moveStage(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Moving...';
  try {
    const r = await fetch('/api/move/' + id, {method:'POST'});
    const d = await r.json();
    if (d.success) { btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Moved \u2713'; }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

async function moveStageFromCompose(id, btn) {
  if (btn.classList.contains('sent') || btn.classList.contains('sending')) return;
  const compose = btn.closest('.compose-move');
  const select = compose.querySelector('.move-stage-select');
  const targetStageId = select.value;
  if (!targetStageId) return;
  const targetLabel = select.options[select.selectedIndex].text;
  btn.classList.remove('ready','failed'); btn.classList.add('sending'); btn.textContent = 'Moving...';
  try {
    const r = await fetch('/api/move/' + id, {method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({targetStageId})});
    const d = await r.json();
    if (d.success) {
      btn.classList.remove('sending'); btn.classList.add('sent'); btn.textContent = 'Moved \u2713';
      const card = btn.closest('.action-card');
      if (card) {
        const icon = card.querySelector('.move-icon'); if (icon) icon.classList.add('sent');
        const badge = card.querySelector('.card-badges .badge');
        if (badge) { badge.textContent = targetLabel; badge.className = 'badge move'; }
      }
    }
    else { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = d.error || ''; }
  } catch(e) { btn.classList.remove('sending'); btn.classList.add('failed'); btn.textContent = 'Failed \u2014 retry'; btn.title = e.message; }
}

function toggleEmailCompose(btn) {
  const card = btn.closest('.action-card');
  const area = card.querySelector('.compose-email');
  const isOpen = area.classList.toggle('open');
  btn.classList.toggle('active', isOpen);
  closeOtherCompose(card, '.compose-sms', '.sms-icon');
  closeOtherCompose(card, '.compose-note', '.note-icon');
  closeOtherCompose(card, '.compose-move', '.move-icon');
}
function toggleSmsCompose(btn) {
  const card = btn.closest('.action-card');
  const area = card.querySelector('.compose-sms');
  const isOpen = area.classList.toggle('open');
  btn.classList.toggle('active', isOpen);
  closeOtherCompose(card, '.compose-email', '.email-icon');
  closeOtherCompose(card, '.compose-note', '.note-icon');
  closeOtherCompose(card, '.compose-move', '.move-icon');
}
function toggleNoteCompose(btn) {
  const card = btn.closest('.action-card');
  const area = card.querySelector('.compose-note');
  const isOpen = area.classList.toggle('open');
  btn.classList.toggle('active', isOpen);
  closeOtherCompose(card, '.compose-email', '.email-icon');
  closeOtherCompose(card, '.compose-sms', '.sms-icon');
  closeOtherCompose(card, '.compose-move', '.move-icon');
}
function toggleMoveCompose(btn) {
  const card = btn.closest('.action-card');
  const area = card.querySelector('.compose-move');
  const isOpen = area.classList.toggle('open');
  btn.classList.toggle('active', isOpen);
  closeOtherCompose(card, '.compose-email', '.email-icon');
  closeOtherCompose(card, '.compose-sms', '.sms-icon');
  closeOtherCompose(card, '.compose-note', '.note-icon');
}
function closeOtherCompose(card, areaSelector, btnSelector) {
  const area = card.querySelector(areaSelector);
  const btn = card.querySelector(btnSelector);
  if (area) area.classList.remove('open');
  if (btn) btn.classList.remove('active');
}

function buildIconButtons(a) {
  const emailSvg = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="m22 7-10 7L2 7"/></svg>';
  const smsSvg = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>';
  const noteSvg = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>';
  const moveSvg = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>';
  const smsDisabled = !a.contactPhone ? ' disabled' : '';
  return '<button class="icon-btn email-icon" onclick="toggleEmailCompose(this)" title="Send email">' + emailSvg + '</button>' +
    '<button class="icon-btn sms-icon" onclick="toggleSmsCompose(this)" title="Send text"' + smsDisabled + '>' + smsSvg + '</button>' +
    '<button class="icon-btn note-icon" onclick="toggleNoteCompose(this)" title="Add note">' + noteSvg + '</button>' +
    '<button class="icon-btn move-icon" onclick="toggleMoveCompose(this)" title="Move stage">' + moveSvg + '</button>';
}

const PIPELINE_STAGES = [
  {id: '29fcf7b0-289c-44a4-ad25-1d1a0aea9063', name: 'New Lead'},
  {id: '5ee824df-7708-4aba-9177-d5ac02dd6828', name: 'In Progress'},
  {id: '259ee5f4-5667-4797-948e-f36ec28c70a0', name: 'Quote Sent'},
  {id: 'accf1eef-aa13-46c3-938d-f3ec6fbe498b', name: 'Needs Attention'},
  {id: '336a5bee-cad2-400f-83fd-cae1bc837029', name: 'Follow Up'},
  {id: '1ab155c2-282d-45eb-bd43-1052489eb2a1', name: 'Sale'},
  {id: '7ec748b8-920d-4bdb-bf09-74dd22d27846', name: 'Cooled Off'},
  {id: 'b909061c-9141-45d7-b1e2-fd37432c3596', name: 'Unqualified'},
];
const STAGE_NAME_TO_ID = Object.fromEntries(PIPELINE_STAGES.map(s => [s.name, s.id]));

function buildComposeAreas(a) {
  const emailSubject = a.subject || a.noAnswerSubject || '';
  const emailBody = a.message || a.noAnswerEmail || '';
  const smsBody = a.smsMessage || a.noAnswerSms || '';
  const inputStyle = 'width:100%;margin-bottom:6px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px;font-size:0.85rem;';
  const textareaStyle = 'width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:inherit;font-size:0.85rem;';
  const selectStyle = 'width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-size:0.85rem;cursor:pointer;';
  const currentStageId = STAGE_NAME_TO_ID[a.stage] || '';
  let stageOptions = '';
  for (const s of PIPELINE_STAGES) {
    const selected = s.id === currentStageId ? ' selected' : '';
    stageOptions += '<option value="' + s.id + '"' + selected + '>' + esc(s.name) + '</option>';
  }
  return '<div class="compose-area compose-email">' +
    '<div class="compose-header"><span class="compose-label">Email</span><button class="send-btn ready" data-action-id="' + a.id + '" onclick="sendEmail(' + a.id + ', this)">Send</button></div>' +
    '<input class="edit-subject" value="' + esc(emailSubject) + '" placeholder="Subject..." style="' + inputStyle + '">' +
    '<textarea class="edit-body" rows="5" style="' + textareaStyle + '">' + esc(emailBody) + '</textarea></div>' +
    '<div class="compose-area compose-sms">' +
    '<div class="compose-header"><span class="compose-label">Text Message</span><button class="send-btn ready" data-action-id="' + a.id + '_sms" onclick="sendSms(' + a.id + ', this)">Send</button></div>' +
    '<textarea class="edit-sms" rows="3" style="' + textareaStyle + '">' + esc(smsBody) + '</textarea></div>' +
    '<div class="compose-area compose-note">' +
    '<div class="compose-header"><span class="compose-label">Note</span><button class="send-btn ready" onclick="saveCardNote(' + a.id + ', this)">Save</button></div>' +
    '<textarea class="card-note" rows="3" placeholder="Add a note about this lead..." style="' + textareaStyle + '"></textarea></div>' +
    '<div class="compose-area compose-move">' +
    '<div class="compose-header"><span class="compose-label">Move Stage</span><button class="send-btn move-btn ready" data-action-id="' + a.id + '_move" onclick="moveStageFromCompose(' + a.id + ', this)">Move</button></div>' +
    '<select class="move-stage-select" style="' + selectStyle + '">' + stageOptions + '</select></div>';
}

function buildEmailCard(a) {
  const company = a.contactCompany ? ` — ${esc(a.contactCompany)}` : '';
  return `<div class="action-card" data-priority="${esc(a.priority)}" data-action-id="${a.id}">
    <div class="card-top">
      <div class="card-badges"><span class="badge followup">${esc(a.stage)}</span></div>
      <div class="card-actions">${buildIconButtons(a)}
        <button class="dismiss-btn" onclick="dismissAction(${a.id}, this)" title="Dismiss">&times;</button>
      </div>
    </div>
    <div class="contact-name">${esc(a.contactName)}${company}${a.contactPhone ? ` &mdash; <a href="tel:${esc(a.contactPhone)}" style="color:var(--accent);text-decoration:none;font-weight:400;font-size:0.9rem;">${fmtPhone(a.contactPhone)}</a>` : ''}</div>
    <div class="context"><strong>Summary:</strong> ${esc(a.context)}</div>
    ${a.recommendation ? `<div class="recommendation"><strong>Recommendation:</strong> ${esc(a.recommendation)}</div>` : ''}
    ${buildComposeAreas(a)}
    <div class="card-inline-actions">
      ${buildConvoHistoryHtml(a.conversationHistory)}
      ${buildNotesHtml(a.notes)}
    </div>
  </div>`;
}

function buildCallCard(a) {
  const company = a.contactCompany ? ` — ${esc(a.contactCompany)}` : '';
  return `<div class="action-card" data-priority="${esc(a.priority)}" data-action-id="${a.id}">
    <div class="card-top">
      <div class="card-badges"><span class="badge call">${esc(a.stage)}</span></div>
      <div class="card-actions">${buildIconButtons(a)}
        <button class="dismiss-btn" onclick="dismissAction(${a.id}, this)" title="Dismiss">&times;</button>
      </div>
    </div>
    <div class="contact-name">${esc(a.contactName)}${company} &mdash; <a href="tel:${esc(a.contactPhone)}" style="color:var(--accent);text-decoration:none;font-weight:400;font-size:0.9rem;">${fmtPhone(a.contactPhone)}</a></div>
    <div class="context"><strong>Summary:</strong> ${esc(a.context)}</div>
    ${a.recommendation ? `<div class="recommendation"><strong>Recommendation:</strong> ${esc(a.recommendation)}</div>` : ''}
    <div class="call-initial">
      <button class="send-btn ready" onclick="showCallResult(this)">I Called</button>
    </div>
    <div class="call-result" style="display:none;">
      <button class="send-btn ready" onclick="showAnswered(this, ${a.id})" style="margin-right:8px;">Answered</button>
      <button class="send-btn ready" onclick="showNoAnswer(this, ${a.id})">No Answer</button>
    </div>
    <div class="call-answered" style="display:none;">
      <textarea class="edit-note" rows="3" placeholder="Add a note about the call..." style="width:100%;margin-bottom:8px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:inherit;font-size:0.85rem;"></textarea>
      <button class="send-btn ready" data-action-id="${a.id}" onclick="saveNote(${a.id}, this)">Save Note</button>
    </div>
    <div class="call-noanswer" style="display:none;">
      <div style="margin-bottom:12px;">
        <div style="font-size:0.8rem;color:var(--text2);margin-bottom:4px;">SMS</div>
        <textarea class="edit-sms" rows="2" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:inherit;font-size:0.85rem;">${esc(a.noAnswerSms || '')}</textarea>
        <button class="send-btn ready" data-action-id="${a.id}_sms" onclick="sendSms(${a.id}, this)" style="margin-top:6px;">Send SMS</button>
      </div>
      <div>
        <div style="font-size:0.8rem;color:var(--text2);margin-bottom:4px;">Email</div>
        <input class="edit-subject" value="${esc(a.noAnswerSubject || '')}" style="width:100%;margin-bottom:6px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:6px;">
        <textarea class="edit-body" rows="4" style="width:100%;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px;padding:8px;font-family:inherit;font-size:0.85rem;">${esc(a.noAnswerEmail || '')}</textarea>
        <button class="send-btn ready" data-action-id="${a.id}_email" onclick="sendEmailFromCall(${a.id}, this)" style="margin-top:6px;">Send Email</button>
      </div>
    </div>
    ${buildComposeAreas(a)}
    <div class="card-inline-actions">
      ${buildConvoHistoryHtml(a.conversationHistory)}
      ${buildNotesHtml(a.notes)}
    </div>
  </div>`;
}

function buildMoveCard(a) {
  const company = a.contactCompany ? ` — ${esc(a.contactCompany)}` : '';
  return `<div class="action-card" data-priority="${esc(a.priority)}" data-action-id="${a.id}">
    <div class="card-top">
      <div class="card-badges"><span class="badge move">${esc(a.stage)}</span></div>
      <div class="card-actions">${buildIconButtons(a)}
        <button class="send-btn move-btn ready" data-action-id="${a.id}" onclick="moveStage(${a.id}, this)">Move to Cooled Off</button>
        <button class="dismiss-btn" onclick="dismissAction(${a.id}, this)" title="Dismiss">&times;</button>
      </div>
    </div>
    <div class="contact-name">${esc(a.contactName)}${company}${a.contactPhone ? ` &mdash; <a href="tel:${esc(a.contactPhone)}" style="color:var(--accent);text-decoration:none;font-weight:400;font-size:0.9rem;">${fmtPhone(a.contactPhone)}</a>` : ''}</div>
    <div class="context"><strong>Summary:</strong> ${esc(a.context)}</div>
    ${a.recommendation ? `<div class="recommendation"><strong>Recommendation:</strong> ${esc(a.recommendation)}</div>` : ''}
    ${buildComposeAreas(a)}
    <div class="card-inline-actions">
      ${buildConvoHistoryHtml(a.conversationHistory)}
      ${buildNotesHtml(a.notes)}
    </div>
  </div>`;
}

function buildActionCard(a) {
  if (a.actionType === 'call' && a.messageType === 'Call') return buildCallCard(a);
  if (a.actionType === 'move') return buildMoveCard(a);
  return buildEmailCard(a);
}

function renderDashboard(data) {
  const actions = data.actions || [];
  const noAction = data.noAction || [];
  const inactiveSummary = data.inactiveSummary || {};

  // Date line
  const today = new Date();
  document.getElementById('date-line').textContent =
    today.toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'}) +
    ' \u2014 Fort Lauderdale Screen Printing';

  // Stats
  const highCount = actions.filter(a => a.priority === 'high').length;
  const medCount = actions.filter(a => a.priority === 'medium').length;
  const lowCount = actions.filter(a => a.priority === 'low' || a.priority === 'info').length;
  document.getElementById('stats-bar').innerHTML =
    `<div class="stat-pill"><span class="num">${actions.length}</span> Actions</div>` +
    `<div class="stat-pill high"><span class="num">${highCount}</span> High</div>` +
    `<div class="stat-pill med"><span class="num">${medCount}</span> Medium</div>` +
    `<div class="stat-pill low"><span class="num">${lowCount}</span> Low</div>`;

  // Group actions by priority
  const groups = {high: [], medium: [], low: [], info: []};
  for (const a of actions) {
    const p = groups[a.priority] ? a.priority : 'low';
    groups[p].push(a);
  }

  let groupsHtml = '';
  const groupMeta = [
    {key:'high', label:'HIGH PRIORITY', cls:'high'},
    {key:'medium', label:'MEDIUM PRIORITY', cls:'med'},
    {key:'low', label:'LOW PRIORITY', cls:'low'},
    {key:'info', label:'INFO', cls:'info'},
  ];
  for (const g of groupMeta) {
    if (groups[g.key].length === 0) continue;
    groupsHtml += `<div class="priority-group">`;
    groupsHtml += `<div class="priority-label ${g.cls}">\u25bc ${g.label} (${groups[g.key].length})</div>`;
    for (const a of groups[g.key]) {
      groupsHtml += buildActionCard(a);
    }
    groupsHtml += `</div>`;
  }
  document.getElementById('action-groups').innerHTML = groupsHtml;

  // No Action Needed
  if (noAction.length > 0) {
    let items = '';
    for (const n of noAction) {
      items += `<div class="no-action-item"><strong>${esc(n.contactName)}</strong> (${esc(n.stage)}) \u2014 ${esc(n.reason)}</div>`;
    }
    document.getElementById('no-action-section').innerHTML =
      `<div class="section"><div class="section-header" onclick="toggleSection(this)">No Action Needed <span>${noAction.length} leads on track</span></div><div class="section-body">${items}</div></div>`;
  }

  // Inactive Summary
  const inactiveTotal = Object.values(inactiveSummary).reduce((s,v) => s+v, 0);
  if (inactiveTotal > 0) {
    let stats = '';
    for (const [label, count] of Object.entries(inactiveSummary)) {
      stats += `<div class="inactive-stat"><div class="num">${count}</div><div class="lbl">${esc(label)}</div></div>`;
    }
    document.getElementById('inactive-section').innerHTML =
      `<div class="section"><div class="section-header" onclick="toggleSection(this)">Inactive Summary <span>${inactiveTotal}</span></div><div class="section-body"><div class="inactive-bar">${stats}</div></div></div>`;
  }

  // Show dashboard, hide loading
  document.getElementById('loading').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';

  // Restore sent/moved/noted/dismissed states
  fetch('/api/status').then(r => r.json()).then(sent => {
    for (const [id, info] of Object.entries(sent)) {
      if (info.status === 'dismissed') {
        const card = document.querySelector('.action-card[data-action-id="' + id + '"]');
        if (card) {
          card.style.display = 'none';
          const group = card.closest('.priority-group');
          if (group) {
            const visible = group.querySelectorAll('.action-card');
            const anyVisible = [...visible].some(c => c.style.display !== 'none');
            if (!anyVisible) group.style.display = 'none';
          }
        }
        continue;
      }
      const btn = document.querySelector('button[data-action-id="' + id + '"]');
      if (btn) {
        btn.classList.remove('ready');
        btn.classList.add('sent');
        if (info.status === 'moved') btn.textContent = 'Moved \u2713';
        else if (info.status === 'noted') btn.textContent = 'Saved \u2713';
        else btn.textContent = 'Sent \u2713';
      }
      // Mark icon buttons as completed
      const baseId = id.split('_')[0];
      const card = document.querySelector('.action-card[data-action-id="' + baseId + '"]');
      if (card) {
        if (id.endsWith('_sms')) {
          const icon = card.querySelector('.sms-icon'); if (icon) icon.classList.add('sent');
        } else if (id.endsWith('_move') || info.status === 'moved') {
          const icon = card.querySelector('.move-icon'); if (icon) icon.classList.add('sent');
        } else if (info.status === 'noted') {
          const icon = card.querySelector('.note-icon'); if (icon) icon.classList.add('sent');
        } else if (info.status === 'sent') {
          const icon = card.querySelector('.email-icon'); if (icon) icon.classList.add('sent');
        }
      }
    }
    updateStats();
  }).catch(() => {});
}

// Fetch action data and render
fetch('/api/actions')
  .then(r => r.json())
  .then(data => renderDashboard(data))
  .catch(e => {
    document.getElementById('loading').textContent = 'Failed to load action data: ' + e.message;
  });
</script>
</body>
</html>
